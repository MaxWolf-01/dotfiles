#!/usr/bin/env bash
# Run Claude in YOLO mode under a dedicated user with passwordless sudo
# Usage: yoloclaude [username|default: coder]

set -euo pipefail

if [[ $EUID -ne 0 ]]; then
  exec sudo "$(realpath "$0")" "$@"
fi

USER_NAME="${1:-coder}"

# 1. Ensure user exists
if ! id -u "$USER_NAME" >/dev/null 2>&1; then
  adduser --disabled-password --gecos "" "$USER_NAME"
fi

# 2. Ensure user is in sudo group
usermod -aG sudo "$USER_NAME"

# 3. Ensure passwordless sudo for that user
SUDOERS_FILE="/etc/sudoers.d/$USER_NAME"
TMP_FILE="${SUDOERS_FILE}.tmp"

printf '%s\n' "$USER_NAME ALL=(ALL) NOPASSWD:ALL" > "$TMP_FILE"

if command -v visudo >/dev/null 2>&1; then
  visudo -cf "$TMP_FILE" || { echo "visudo syntax check failed"; rm -f "$TMP_FILE"; exit 1; }
fi

mv "$TMP_FILE" "$SUDOERS_FILE"
chmod 440 "$SUDOERS_FILE"

# 4. Ensure claude is accessible system-wide (copy since coder can't traverse max's home)
CLAUDE_BIN="/home/max/.local/share/claude/versions/2.0.61"
if [[ ! -f /usr/local/bin/claude ]] || ! cmp -s "$CLAUDE_BIN" /usr/local/bin/claude; then
  cp "$CLAUDE_BIN" /usr/local/bin/claude
  chmod 755 /usr/local/bin/claude
fi

# 5. Switch to that user and launch Claude in YOLO mode
su - "$USER_NAME" -c 'claude --dangerously-skip-permissions'
