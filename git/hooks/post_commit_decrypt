#!/usr/bin/env bash
set -euo pipefail

# Post-commit hook to decrypt files from encrypted/*.age to decrypted/

cd "$(git rev-parse --show-toplevel)"

KEY_FILE="$HOME/.local/secrets/age-key.txt"

if [ ! -f "$KEY_FILE" ]; then
    echo "Error: age key not found at $KEY_FILE"
    echo "Generate with: age-keygen -o $KEY_FILE"
    exit 1
fi

mkdir -p decrypted

# Decrypt all age files (recursively)
find encrypted -name "*.age" -type f | while read -r file; do
    # Get relative path from encrypted/ and remove .age extension
    relative_path="${file#encrypted/}"
    relative_path="${relative_path%.age}"
    decrypted_file="decrypted/$relative_path"
    
    # Create directory structure in decrypted/
    mkdir -p "$(dirname "$decrypted_file")"
    
    echo "Decrypting $relative_path..."
    age -d -i "$KEY_FILE" -o "$decrypted_file" "$file"
done