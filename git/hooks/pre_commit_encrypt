#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook to encrypt files in decrypted/ to encrypted/*.age

cd "$(git rev-parse --show-toplevel)"

KEY_FILE="$HOME/.local/secrets/age-key.txt"

if [ ! -f "$KEY_FILE" ]; then
    echo "Error: age key not found at $KEY_FILE"
    echo "Generate with: age-keygen -o $KEY_FILE"
    exit 1
fi

# Get public key from private key
public_key=$(age-keygen -y "$KEY_FILE")

# Encrypt all files in decrypted/ (recursively)
find decrypted -type f | while read -r file; do
    # Get relative path from decrypted/
    relative_path="${file#decrypted/}"
    encrypted_file="encrypted/${relative_path}.age"
    
    # Create directory structure in encrypted/
    mkdir -p "$(dirname "$encrypted_file")"
    
    echo "Encrypting $relative_path..."
    age -r "$public_key" -o "$encrypted_file" "$file"
    
    # Stage the encrypted file
    git add "$encrypted_file"
    
    # Unstage the plaintext file
    git rm --cached "$file" 2>/dev/null || true
done