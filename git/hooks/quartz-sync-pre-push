#!/bin/bash
# Pre-push hook to sync content to Quartz repo before pushing

echo "Running local sync to Quartz repository..."

# Set up paths
VAULT_DIR="$(git rev-parse --show-toplevel)"
QUARTZ_DIR="$HOME/repos/obsidian/quartz-knowledge-base"
LOG_DIR="$HOME/logs"
LOG_FILE="$LOG_DIR/knowledge-base-sync-$(date +%Y%m%d-%H%M%S).log"

# Create logs directory if it doesn't exist
mkdir -p "$LOG_DIR"

# Check if Quartz repo exists
if [ ! -d "$QUARTZ_DIR" ]; then
    echo "=== WARNING: Quartz repository not found at $QUARTZ_DIR ==="
    echo "To enable Quartz sync, clone it first: git clone git@github.com:MaxWolf-01/quartz-knowledge-base.git $QUARTZ_DIR"
    echo "Continuing with knowledge-base push without Quartz sync..."
    exit 0
fi

# Run the sync script with logging
echo "Syncing content... (log: $LOG_FILE)"
cd "$VAULT_DIR"
export QUARTZ_DIR  # Make it available to the Python script
python3 sync_whitelist.py 2>&1 | tee "$LOG_FILE"

# Check if sync was successful
if [ ${PIPESTATUS[0]} -ne 0 ]; then
    echo "Sync failed. Push aborted. Check log: $LOG_FILE"
    exit 1
fi

echo "Sync log saved to: $LOG_FILE"

# Commit and push changes in Quartz repo
cd "$QUARTZ_DIR"
if [ -n "$(git status --porcelain content/)" ]; then
    echo "Committing changes to Quartz repo..."
    git add content/
    git commit -m "Sync content from knowledge-base (local pre-push)"
    
    echo "Pushing to Quartz repo..."
    git push
    
    if [ $? -ne 0 ]; then
        echo "Warning: Failed to push to Quartz repo. You may need to push manually."
        echo "The knowledge-base push will continue."
    fi
else
    echo "No changes to sync to Quartz repo."
fi

echo "Local sync complete. Proceeding with knowledge-base push..."
exit 0
