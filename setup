#!/bin/bash

DOTFILES="$HOME/.dotfiles"

# Override sudo when running as root
if [ "$EUID" -eq 0 ]; then
    sudo() {
        "$@"
    }
fi

symlinks() {
    # Create directories
    mkdir -p ~/.ssh
    mkdir -p ~/applications
    mkdir -p ~/bin
    mkdir -p ~/repos/tools
    mkdir -p ~/tmp
    mkdir -p ~/logs

    # Clean dead symlinks
    find ~ -maxdepth 1 -type l ! -exec test -e {} \; -delete 2>/dev/null || true
    find ~/.ssh -maxdepth 1 -type l ! -exec test -e {} \; -delete 2>/dev/null || true

    # Symlink helper
    link() {
        local src="$DOTFILES/$1"
        local dst="$2"
        mkdir -p "$(dirname "$dst")"
        rm -rf "$dst"
        ln -sf "$src" "$dst"
    }

    # zsh files: ~/.zshrc managed by Home Manager, rest sourced directly from dotfiles

    link git/gitconfig ~/.gitconfig
    link git/gitignore_global ~/.gitignore_global
    link git/gitattributes ~/.gitattributes

    link vim/vimrc ~/.vimrc
    link vim/ideavimrc ~/.ideavimrc

    link tmux/tmux.conf ~/.tmux.conf
    link bin ~/bin
    link desktop/icons ~/.icons
    link python/pythonrc ~/.pythonrc

    link nvim ~/.config/nvim
    link kitty ~/.config/kitty
    link ruff ~/.config/ruff
    link nix/nix.conf ~/.config/nix/nix.conf
    link oyo/config.toml ~/.config/oyo/config.toml

    echo "Symlinks created."
}

minimal() {
    symlinks
    # install minimal system-level tools (most CLI tools now via Nix/Home Manager)
    export NONINTERACTIVE=1
    sudo apt-get update
    sudo apt-get install -y \
      build-essential \
      gcc \
      zsh
    sudo chsh -s "$(which zsh)" "$USER" # set zsh as default shell

    sudo mkdir -p /usr/local/bin
    sudo ln -sf ~/bin/* /usr/local/bin/

    zsh zsh/plugin-files/zap_zsh_install # minimal zsh plugin manager

    touch ~/.local_exports

    if ! command -v nix &> /dev/null; then
        sh <(curl -L https://nixos.org/nix/install) --daemon --yes
        echo "Nix installed. Restart shell, set NIX_HOST in ~/.local_exports, then:"
        echo "  nix run home-manager/master -- switch --flake ~/.dotfiles#\$NIX_HOST"
    fi
}

cli() {
    git lfs install  # git-lfs binary from Nix, just configure hooks

    uv tool install ipdb
    uv tool install pywal

    # Nerd fonts for terminal icons (works on any Linux)
    if ! fc-list | grep -qi "nerd"; then
        mkdir -p ~/.local/share/fonts
        curl -fLo /tmp/Hack.zip https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Hack.zip
        unzip -o /tmp/Hack.zip -d ~/.local/share/fonts/Hack
        rm /tmp/Hack.zip
        fc-cache -fv
    fi

    get_claude

    # go install github.com/LeperGnome/bt/cmd/bt@v1.2.2

    # btop from source for GPU support (nixpkgs version lacks it)
    cd "$HOME/repos/tools" && { if [ -d "btop" ]; then cd btop && git pull; else git clone --depth 1 https://github.com/aristocratos/btop.git && cd btop; fi; sudo make && sudo make install; }
}

ubuntu() {
  sudo apt-get update
  sudo apt-get install -y \
    libfuse2 \
    baobab \
    blueman \
    gnome-shell-extensions-gpaste \
    gparted \
    pulseaudio-module-bluetooth \
    qdirstat \
    virt-viewer

  # Enable unprivileged user namespaces for Electron app sandboxing
  # Ubuntu 23.10+ uses AppArmor to restrict userns per-app; disable that restriction
  echo 'kernel.apparmor_restrict_unprivileged_userns=0' | sudo tee /etc/sysctl.d/60-apparmor-namespace.conf
  sudo sysctl --system

  ./bin/keybindings.pl -i

  # disable screenshot sound
  if [ -f "/usr/share/sounds/freedesktop/stereo/camera-shutter.oga" ]; then
      sudo mv /usr/share/sounds/freedesktop/stereo/camera-shutter.oga /usr/share/sounds/freedesktop/stereo/camera-shutter-disabled.oga
  fi

  # webp support for eye of gnome image viewer
  # yes | sudo add-apt-repository ppa:helkaluin/webp-pixbuf-loader (ships with >=22.04)
  sudo apt install webp-pixbuf-loader
  xdg-mime default org.gnome.eog.desktop image/webp

  obsidian
  obsidian_vault desktop shallow

  # Setup all desktop entries
  for desktop_file in "$HOME"/.dotfiles/desktop/*.desktop; do
    if [ -f "$desktop_file" ]; then
      filename=$(basename "$desktop_file")
      sed "s|\$HOME|$HOME|g" "$desktop_file" > "$HOME/.local/share/applications/$filename"
      echo "Installed desktop entry: $filename"
    fi
  done
  update-desktop-database "$HOME"/.local/share/applications/

  # Setup default MIME type associations
  # Text and code files to nvim
  xdg-mime default nvim.desktop text/plain
  xdg-mime default nvim.desktop text/markdown
  xdg-mime default nvim.desktop text/x-python
  xdg-mime default nvim.desktop text/x-shellscript
  xdg-mime default nvim.desktop text/x-yaml
  xdg-mime default nvim.desktop text/x-toml
  xdg-mime default nvim.desktop application/json
  xdg-mime default nvim.desktop application/javascript
  xdg-mime default nvim.desktop application/x-shellscript
  
  # Obsidian for its protocol
  xdg-mime default obsidian.desktop x-scheme-handler/obsidian
  
  # Browser for HTML
  xdg-mime default firefox.desktop text/html
  xdg-mime default firefox.desktop x-scheme-handler/http
  xdg-mime default firefox.desktop x-scheme-handler/https

  sudo snap install celluloid

  ### remove bloat
  # screen reader
  sudo apt-get remove -y orca
  # braille display driver
  sudo apt-get remove -y brltty
}

# todo https://github.com/nix-community/nix-on-droid-app
android() {
  # https://android.stackexchange.com/a/185949
  pkg update && pkg upgrade
  pkg install python gh fastfetch git-lfs zsh vim htop
  git lfs install

  ln -sf ~/storage/shared/repos ~/repos  # can't do it the other way round without root
  obsidian_vault mobile shallow
  git config --global --add safe.directory ~/storage/shared/repos/obsidian/knowledge-base

  zsh zsh/plugin-files/zap_zsh_install # minimal zsh plugin manager
  chsh -s zsh # set zsh as default shell

  # TODO: fuzzy_finder function was removed, fzf now via nix
  curl -LsSf https://astral.sh/uv/install.sh | sh

  echo "source ~/.dotfiles/zsh/android" >> ~/.zshrc
}

docker() {
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh ./get-docker.sh
    sudo usermod -a -G docker $USER
    rm get-docker.sh
    echo "Reboot to apply changes"
}

nvidia_container_toolkit() {
    # Enables Docker containers to use NVIDIA GPUs (--runtime=nvidia / --gpus all)
    # Requires: NVIDIA drivers installed, Docker installed
    if ! command -v nvidia-smi &> /dev/null; then
        echo "Error: NVIDIA drivers not installed (nvidia-smi not found)"
        return 1
    fi
    if ! command -v docker &> /dev/null; then
        echo "Error: Docker not installed"
        return 1
    fi

    echo "Installing NVIDIA Container Toolkit..."

    curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | \
        sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg --yes

    curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
        sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
        sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list

    sudo apt-get update
    sudo apt-get install -y nvidia-container-toolkit

    sudo nvidia-ctk runtime configure --runtime=docker
    sudo systemctl restart docker

    echo "NVIDIA Container Toolkit installed. Restart docker or reboot to apply."
}

get_oyo() {
    # Terminal diff viewer - https://github.com/ahkohd/oyo
    if ! command -v cargo &> /dev/null; then
        echo "Error: cargo not found. Install rustup first: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh"
        return 1
    fi
    cargo install oyo
    echo "oyo installed. Usage: oy file1 file2"
}

get_vibetyper() {
    # Speech-to-text app. Auto-updates and creates its own desktop entries on launch.
    wget -O "$HOME/applications/VibeTyper.AppImage" "https://cdn.vibetyper.com/releases/linux/VibeTyper.AppImage"
    chmod +x "$HOME/applications/VibeTyper.AppImage"
}

act() {
    # local github actions runner
    curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo zsh
}

get_veracrypt() {
  # encrypted volumes
  yes | sudo add-apt-repository ppa:unit193/encryption
  sudo apt-get update
  sudo apt-get install -y veracrypt
}

get_claude() {
  curl -fsSL https://claude.ai/install.sh | bash
  mkdir -p ~/.claude/plugins
  rm -rf ~/.claude/settings.json ~/.claude/CLAUDE.md ~/.claude/commands ~/.claude/output-styles ~/.claude/mcp.json
  ln -sf "$DOTFILES/claude/settings.json" ~/.claude/settings.json
  ln -sf "$DOTFILES/claude/CLAUDE.md" ~/.claude/CLAUDE.md
  ln -sf "$DOTFILES/claude/commands" ~/.claude/commands
  ln -sf "$DOTFILES/claude/output-styles" ~/.claude/output-styles
  ln -sf "$DOTFILES/claude/mcp.json" ~/.claude/mcp.json

  npm install -g claude-code-wakatime
  claude plugin marketplace add https://github.com/wakatime/claude-code-wakatime.git 2>/dev/null || true
  claude plugin marketplace add anthropics/claude-plugins-official 2>/dev/null || true
  claude plugin marketplace add MaxWolf-01/agents 2>/dev/null || true
  claude plugin i claude-code-wakatime@wakatime 2>/dev/null || true
  claude plugin i frontend-design@claude-code-plugins 2>/dev/null || true
  claude plugin i feature-dev@claude-code-plugins 2>/dev/null || true
  claude plugin i context7@claude-plugins-official 2>/dev/null || true
  claude plugin i frontend-design@claude-plugins-official 2>/dev/null || true
  claude plugin i mx@MaxWolf-01 2>/dev/null || true
}

secrets() {
  local key_file="$HOME/.local/secrets/age-key.txt"

  if ! [ -d ~/.dotfiles/secrets ]; then
    gh repo clone MaxWolf-01/secrets ~/.dotfiles/secrets -- --depth 1
  fi

  if [ ! -f "$key_file" ]; then
    echo "Age key not found at $key_file"
    echo "Generate a new key with: age-keygen -o $key_file"
    echo "Or place your existing key there, then run './setup secrets' again"
    return
  fi

  cd ~/.dotfiles/secrets && git pull

  export SOPS_AGE_KEY_FILE="$key_file"

  ln -sf ~/.dotfiles/secrets/ssh/config ~/.ssh/config
  sops -d ~/.dotfiles/secrets/api_keys/wakatime.cfg > ~/.wakatime.cfg
  #  find ~/.dotfiles/secrets/bin -type f -exec ln -sf {} ~/bin/ \;
}

vim_copilot() {
    git clone --depth 1 https://github.com/github/copilot.vim.git ~/.vim/pack/github/start/copilot.vim
}

obsidian_vault() {
    # TODO use separate repositories / find a better solution for differing settings...
    local platform=${1:-desktop}  # Default to desktop if no argument provided
    local depth=${2:-full}       # Default to full clone if no depth specified
    local depth_arg=""
    if [ "$depth" = "shallow" ]; then
        depth_arg="--depth 1"
    fi

    path=~/repos/obsidian
    if [ "$platform" = "mobile" ]; then
      path=~/storage/shared/obsidian
    fi
    mkdir -pv "$path" && cd "$path" || exit

    if [ -d "knowledge-base" ]; then
        echo "knowledge-base already exists"
        return
    fi

    git clone $depth_arg git@github.com:MaxWolf-01/knowledge-base.git
    cd knowledge-base || exit
    git clone $depth_arg git@github.com:MaxWolf-01/.obsidian

    cd .obsidian && ./switch_platform.sh "$platform" || exit

    ln -sf ~/.dotfiles/vim/obsidian "$path/knowledge-base/.obsidian.vimrc"
    ln -sf ~/.dotfiles/git/hooks/check_question_mark_in_filename "$path/knowledge-base/.git/hooks/pre-commit"

    # Set up pre-push hook for local Quartz sync
    if [ "$platform" = "desktop" ]; then
        ln -sf ~/.dotfiles/git/hooks/quartz-sync-pre-push "$path/knowledge-base/.git/hooks/pre-push"
        echo "Pre-push hook for Quartz sync installed"

        # Set up Claude Code obsidian skills
        if [ ! -d ~/repos/tools/obsidian-skills ]; then
            git clone --depth 1 https://github.com/kepano/obsidian-skills.git ~/repos/tools/obsidian-skills
        fi
        mkdir -p "$path/knowledge-base/.claude/skills"
        for skill in ~/repos/tools/obsidian-skills/*/; do
            skill_name=$(basename "$skill")
            [ -f "$skill/SKILL.md" ] && ln -sf "$skill" "$path/knowledge-base/.claude/skills/$skill_name"
        done
        echo "Claude Code obsidian skills installed"
    fi
}


obsidian() {
    appimage="$(find ~/Downloads -name 'Obsidian*.AppImage')"
    if [ -z "$appimage" ]; then
        echo "Error: No Obsidian AppImage found in Downloads."
        exit 1
    fi
    COUNT=$(echo "$appimage" | wc -l)
    if [ $COUNT -gt 1 ]; then
        echo "Warning: Multiple Obsidian AppImages found. Using the first one."
    fi
    appimage=$(echo "$appimage" | head -n 1)
    echo "Using Obsidian AppImage: $appimage"
    mv "$appimage" ~/applications/obsidian.AppImage
    chmod +x ~/applications/obsidian.AppImage
    sed "s|\$HOME|$HOME|g" "$HOME"/.dotfiles/desktop/obsidian.desktop > "$HOME"/.local/share/applications/obsidian.desktop
    update-desktop-database "$HOME"/.local/share/applications/
    echo "Obsidian app set up."
}

discord() {
  wget -O /tmp/discord.deb "https://discord.com/api/download?platform=linux&format=deb"
  sudo dpkg -i /tmp/discord.deb
  rm /tmp/discord.deb
}

tiling_shell() {
  # Temporary: nixpkgs only has GNOME 45+ build, this installs GNOME 42-44 build
  # TODO: remove when on GNOME 45+ and re-enable in gnome.nix
  gnome_version=$(gnome-shell --version | grep -oP '\d+' | head -1)
  if [ "$gnome_version" -ge 45 ]; then
    echo "GNOME $gnome_version detected. Use Nix version instead (uncomment in gnome.nix)"
    return
  fi
  echo "Installing Tiling Shell for GNOME 42-44..."
  ext_dir="$HOME/.local/share/gnome-shell/extensions/tilingshell@ferrarodomenico.com"
  rm -rf "$ext_dir"
  mkdir -p "$ext_dir"
  curl -fsSL "https://github.com/domferr/tilingshell/releases/latest/download/GNOME.42-44.tilingshell@ferrarodomenico.com.zip" -o /tmp/tilingshell.zip
  unzip -o /tmp/tilingshell.zip -d "$ext_dir"
  rm /tmp/tilingshell.zip
  echo "Tiling Shell installed. Log out and back in to enable."
}


### Networking etc

wireguard_client() {
  sudo apt update && sudo apt install -y wireguard resolveconf
  mkdir -p ~/wireguard && chmod 700 ~/wireguard
  wg genkey | tee ~/wireguard/private.key
  cat ~/wireguard/private.key | wg pubkey | tee ~/wireguard/public.key
  echo "EXECUTE THE FOLLOWING ON THE VPS SERVER, then create a new client and copy the client config to ~/wireguard/wg0.conf\n--------------"
  echo "curl -O https://raw.githubusercontent.com/angristan/wireguard-install/master/wireguard-install.sh
  chmod +x wireguard-install.sh
  ./wireguard-install.sh"
  echo "When done, execute (on the CLIENT):\nsudo wg-quick up ~/wireguard/wg0.conf"
}

sshkeys() {
  ssh-keygen -t ed25519 -C "69987866+MaxWolf-01@users.noreply.github.com"
  find ~/.ssh/ -type f -exec chmod 600 {} \; && find ~/.ssh/ -type d -exec chmod 700 {} \; && find ~/.ssh/ -type f -name "*.pub" -exec chmod 644 {} \;
  ssh-add ~/.ssh/id_ed25519
  cat ~/.ssh/id_ed25519.pub
  echo "Put your public key on github -> settings -> SSH and GPG keys"
}

openconnect() {
    sudo apt-get update && sudo apt-get install network-manager-openconnect network-manager-openconnect-gnome
    sudo systemctl restart NetworkManager
}

nvidia_optimus() {
  # TODO iGPU not used / display not working if hybrid / off
  cd ~/repos/tools
  if [ -d "envycontrol" ]; then cd envycontrol && git pull; else git clone --depth 1 https://github.com/bayasdev/envycontrol.git && cd envycontrol; fi;
  sudo pip install .
  # https://github.com/bayasdev/envycontrol/wiki/Frequently-Asked-Questions#instructions-for-ubuntu-and-its-derivatives
  sudo prime-select on-demand
  sudo systemctl mask gpu-manager.service
  sudo apt-get install -y gnome-tweaks
  echo "Install the gui manager according to gnome version @ https://github.com/LorenzoMorelli/GPU_profile_selector?tab=readme-ov-file#manual"
}

# Check if the first argument is the name of a function
if declare -f "$1" > /dev/null; then
  # Call the function with the rest of the arguments
  "$@"
else
  echo "$1 is not a function"
fi
